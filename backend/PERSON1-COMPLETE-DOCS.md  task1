# üîê Person 1 - Authentication Module Documentation

## üìä 1. DATABASE SCHEMA

### MongoDB Collection: `users`

```javascript
{
  _id: ObjectId,                    // Auto-generated by MongoDB
  firstName: String,                 // User's first name
  lastName: String,                  // User's last name
  email: String,                     // Unique email (lowercase)
  password: String,                  // Hashed password (bcrypt)
  role: String,                      // "user" or "admin" (default: "user")
  loginAttempts: Number,             // Failed login counter (default: 0)
  lastLoginAttempt: Date,            // Last failed login timestamp
  createdAt: Date,                   // Auto-generated
  updatedAt: Date                    // Auto-generated
}
```

### Field Details:

| Field              | Type      | Required | Unique | Default | Validation                           |
|--------------------|-----------|----------|--------|---------|--------------------------------------|
| `_id`              | ObjectId  | Auto     | Yes    | Auto    | MongoDB ObjectId                     |
| `firstName`        | String    | ‚úÖ       | No     | -       | Non-empty, trimmed                   |
| `lastName`         | String    | ‚úÖ       | No     | -       | Non-empty, trimmed                   |
| `email`            | String    | ‚úÖ       | ‚úÖ     | -       | Valid email format, lowercase        |
| `password`         | String    | ‚úÖ       | No     | -       | Min 8 characters (hashed with bcrypt)|
| `role`             | String    | No       | No     | "user"  | Enum: ["user", "admin"]              |
| `loginAttempts`    | Number    | No       | No     | 0       | Integer                              |
| `lastLoginAttempt` | Date      | No       | No     | null    | Date object                          |
| `createdAt`        | Date      | Auto     | No     | Auto    | Timestamp                            |
| `updatedAt`        | Date      | Auto     | No     | Auto    | Timestamp                            |

### Indexes:
- `email`: Unique index (prevents duplicate emails)
- MongoDB automatically indexes `_id`

---

## üåê 2. AUTHENTICATION ROUTES & ENDPOINTS

### Base URL:
```
http://localhost:3000/api/auth
```

---

### üìù **Endpoint 1: REGISTER**

**Route:** `POST /api/auth/register`

**Purpose:** Create new user account

**Request Headers:**
```
Content-Type: application/json
```

**Request Body:**
```json
{
  "firstName": "Ahmed",
  "lastName": "Mohamed",
  "email": "ahmed@example.com",
  "password": "SecurePass123"
}
```

**What Happens Inside:**
1. ‚úÖ Validates all required fields exist
2. ‚úÖ Validates email format (must be valid email)
3. ‚úÖ Validates password length (min 8 characters)
4. ‚úÖ Checks if email already exists in database
5. ‚úÖ Hashes password with bcrypt (10 salt rounds)
6. ‚úÖ Creates new user in MongoDB
7. ‚úÖ Generates JWT token (valid for 24 hours)
8. ‚úÖ Returns user data + token

**Success Response (201 Created):**
```json
{
  "message": "User registered successfully",
  "token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1c2VySWQiOiI2NWE...",
  "user": {
    "id": "65a1b2c3d4e5f6g7h8i9j0k1",
    "firstName": "Ahmed",
    "lastName": "Mohamed",
    "email": "ahmed@example.com",
    "role": "user"
  }
}
```

**Error Responses:**

| Status Code | Error Message | Reason |
|-------------|---------------|--------|
| 400 | `All fields are required` | Missing firstName, lastName, email, or password |
| 400 | `Password must be at least 8 characters` | Password too short |
| 409 | `Email already registered` | Email exists in database |
| 500 | `Server error` | Internal server error |

---

### üîë **Endpoint 2: LOGIN**

**Route:** `POST /api/auth/login`

**Purpose:** Authenticate existing user

**Request Headers:**
```
Content-Type: application/json
```

**Request Body:**
```json
{
  "email": "ahmed@example.com",
  "password": "SecurePass123"
}
```

**What Happens Inside:**
1. ‚úÖ Validates email and password are provided
2. ‚úÖ Finds user by email in database
3. ‚úÖ Checks login attempts (max 5 attempts)
4. ‚úÖ If locked: Checks if 15 minutes passed since last attempt
5. ‚úÖ Compares password with hashed password (bcrypt)
6. ‚úÖ If wrong: Increments login attempts counter
7. ‚úÖ If correct: Resets login attempts to 0
8. ‚úÖ Generates JWT token (valid for 24 hours)
9. ‚úÖ Returns user data + token

**Success Response (200 OK):**
```json
{
  "message": "Login successful",
  "token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1c2VySWQiOiI2NWE...",
  "user": {
    "id": "65a1b2c3d4e5f6g7h8i9j0k1",
    "firstName": "Ahmed",
    "lastName": "Mohamed",
    "email": "ahmed@example.com",
    "role": "user"
  }
}
```

**Error Responses:**

| Status Code | Error Message | Reason |
|-------------|---------------|--------|
| 400 | `Email and password are required` | Missing email or password |
| 401 | `Invalid email or password` | Wrong credentials |
| 429 | `Too many login attempts. Account locked. Try again in X minutes.` | 5+ failed attempts |
| 500 | `Server error` | Internal server error |

---

## ‚úÖ 3. VALIDATION RULES

### üìß **Email Validation:**

**Format Required:**
```
name@domain.extension
```

**Rules:**
- ‚úÖ Must contain `@` symbol
- ‚úÖ Must have domain (e.g., `gmail.com`, `example.com`)
- ‚úÖ Must have valid extension (`.com`, `.net`, etc.)
- ‚úÖ No spaces allowed
- ‚úÖ Automatically converted to lowercase
- ‚úÖ Must be unique (cannot register twice)

**Valid Examples:**
```
‚úÖ ahmed@gmail.com
‚úÖ user.name@example.co.uk
‚úÖ test123@domain.net
```

**Invalid Examples:**
```
‚ùå ahmed              (no @ or domain)
‚ùå ahmed@            (no domain)
‚ùå @gmail.com        (no username)
‚ùå ahmed gmail.com   (no @)
‚ùå ahmed@gmail       (no extension)
```

**Error Response:**
```json
{
  "error": "Validation failed",
  "details": ["Please provide a valid email"]
}
```

---

### üîí **Password Validation:**

**Rules:**
- ‚úÖ **Minimum Length:** 8 characters
- ‚úÖ Can contain letters, numbers, symbols
- ‚úÖ No maximum length
- ‚úÖ Automatically hashed before saving (you never see the real password)

**Valid Examples:**
```
‚úÖ 12345678          (8 characters)
‚úÖ SecurePass123     (12 characters)
‚úÖ My$ecur3P@ss      (special chars)
```

**Invalid Examples:**
```
‚ùå 1234567           (only 7 characters)
‚ùå pass              (only 4 characters)
‚ùå abc123            (only 6 characters)
```

**Error Response:**
```json
{
  "error": "Password must be at least 8 characters"
}
```

---

### üë§ **First Name & Last Name Validation:**

**Rules:**
- ‚úÖ Cannot be empty
- ‚úÖ Whitespace trimmed automatically
- ‚úÖ Any characters allowed

**Error Response:**
```json
{
  "error": "All fields are required",
  "required": ["firstName", "lastName", "email", "password"]
}
```

---

## üîê 4. SECURITY FEATURES

### Password Hashing:
- **Algorithm:** bcrypt
- **Salt Rounds:** 10
- **Automatic:** Happens in Mongoose pre-save hook
- **Original password is NEVER stored**

Example hashed password:
```
$2b$10$N9qo8uLOickgx2ZMRZoMyeIjZAgcfl7p92ldGxad68LJZdL17lhWy
```

### JWT Token:
- **Expiration:** 24 hours
- **Contains:** userId, email, firstName, lastName
- **Secret:** Stored in `.env` file

### Login Attempt Limiting:
- **Max Attempts:** 5 failed logins
- **Lockout Duration:** 15 minutes
- **Auto-Reset:** After successful login or lockout period

---

## üì± 5. FRONTEND INTEGRATION GUIDE

### Registration Form:

**HTML Inputs Needed:**
```html
<form id="registerForm">
  <input type="text" name="firstName" placeholder="First Name" required>
  <input type="text" name="lastName" placeholder="Last Name" required>
  <input type="email" name="email" placeholder="Email" required>
  <input type="password" name="password" placeholder="Password (min 8 chars)" required minlength="8">
  <button type="submit">Register</button>
</form>
```

**JavaScript Example:**
```javascript
document.getElementById('registerForm').addEventListener('submit', async (e) => {
  e.preventDefault();
  
  const data = {
    firstName: document.querySelector('[name="firstName"]').value,
    lastName: document.querySelector('[name="lastName"]').value,
    email: document.querySelector('[name="email"]').value,
    password: document.querySelector('[name="password"]').value
  };
  
  try {
    const response = await fetch('http://localhost:3000/api/auth/register', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(data)
    });
    
    const result = await response.json();
    
    if (response.ok) {
      // Success! Store token
      localStorage.setItem('token', result.token);
      localStorage.setItem('user', JSON.stringify(result.user));
      alert('Registration successful!');
      // Redirect to dashboard
    } else {
      // Show error
      alert(result.error);
    }
  } catch (error) {
    alert('Network error');
  }
});
```

---

### Login Form:

**HTML Inputs Needed:**
```html
<form id="loginForm">
  <input type="email" name="email" placeholder="Email" required>
  <input type="password" name="password" placeholder="Password" required>
  <button type="submit">Login</button>
</form>
```

**JavaScript Example:**
```javascript
document.getElementById('loginForm').addEventListener('submit', async (e) => {
  e.preventDefault();
  
  const data = {
    email: document.querySelector('[name="email"]').value,
    password: document.querySelector('[name="password"]').value
  };
  
  try {
    const response = await fetch('http://localhost:3000/api/auth/login', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(data)
    });
    
    const result = await response.json();
    
    if (response.ok) {
      // Success! Store token
      localStorage.setItem('token', result.token);
      localStorage.setItem('user', JSON.stringify(result.user));
      alert('Login successful!');
      // Redirect to dashboard
    } else {
      // Show error
      alert(result.error);
      
      // Handle lockout
      if (response.status === 429) {
        alert('Account locked. Try again later.');
      }
    }
  } catch (error) {
    alert('Network error');
  }
});
```

---

### Using JWT Token for Protected Routes:

```javascript
// Example: Fetch user profile
const token = localStorage.getItem('token');

fetch('http://localhost:3000/api/protected-endpoint', {
  method: 'GET',
  headers: {
    'Authorization': `Bearer ${token}`,
    'Content-Type': 'application/json'
  }
})
.then(response => response.json())
.then(data => console.log(data));
```

---

## üìã 6. STEP-BY-STEP IMPLEMENTATION CHECKLIST

### ‚úÖ Backend (Already Done):
- [x] MongoDB connection setup
- [x] User model with validation
- [x] Password hashing (bcrypt)
- [x] Register endpoint
- [x] Login endpoint
- [x] JWT token generation
- [x] Login attempt limiting
- [x] Authentication middleware
- [x] Email validation
- [x] Password validation

### üì± Frontend (To Do):
- [ ] Create registration form (4 inputs: firstName, lastName, email, password)
- [ ] Create login form (2 inputs: email, password)
- [ ] Add client-side validation (email format, password min 8 chars)
- [ ] Handle form submissions (fetch API)
- [ ] Store JWT token in localStorage
- [ ] Display error messages to user
- [ ] Handle lockout messages (429 error)
- [ ] Redirect after successful login/register

---

## üß™ 7. TESTING WITH THUNDER CLIENT

### Test Registration:
```
POST http://localhost:3000/api/auth/register
Content-Type: application/json

{
  "firstName": "Ahmed",
  "lastName": "Mohamed",
  "email": "ahmed@test.com",
  "password": "12345678"
}
```

**Expected Result:** Status 201, token + user data

---

### Test Login:
```
POST http://localhost:3000/api/auth/login
Content-Type: application/json

{
  "email": "ahmed@test.com",
  "password": "12345678"
}
```

**Expected Result:** Status 200, token + user data

---

### Test Validation Errors:

**Missing fields:**
```json
{
  "firstName": "Ahmed"
}
```
**Expected:** Status 400, "All fields are required"

---

**Short password:**
```json
{
  "firstName": "Ahmed",
  "lastName": "Mohamed",
  "email": "test@test.com",
  "password": "123"
}
```
**Expected:** Status 400, "Password must be at least 8 characters"

---

**Invalid email:**
```json
{
  "firstName": "Ahmed",
  "lastName": "Mohamed",
  "email": "notanemail",
  "password": "12345678"
}
```
**Expected:** Status 400, "Please provide a valid email"

---

**Duplicate email:**
Register twice with same email
**Expected:** Status 409, "Email already registered"

---

**Wrong password (5 times):**
Try login with wrong password 5 times
**Expected:** Status 429, "Account locked"

---

## üìä 8. DATABASE SCHEMA SUMMARY FOR TEAM

### For Person 2 (File Upload):
**You will need to:**
- Create `File` model with fields: `filename`, `size`, `uploadedBy` (reference to User._id)
- Use `authMiddleware` to get `req.user.userId`
- Encrypt file with `encryptBuffer()` from `utils/fileCrypto.js`

### For Person 3 (File Download):
**You will need to:**
- Use `authMiddleware` to verify user identity
- Check if user has permission to download file
- Decrypt file with `decryptBuffer()` from `utils/fileCrypto.js`
- Log download activity with `req.user.userId`

---

## üéØ READY TO USE!

‚úÖ **Backend:** Complete and tested
‚úÖ **Database:** MongoDB connected and working
‚úÖ **Validation:** All rules implemented
‚úÖ **Security:** Password hashing, JWT, rate limiting
‚úÖ **Documentation:** Complete for frontend team

**Server Status:** Running on `http://localhost:3000` üü¢
