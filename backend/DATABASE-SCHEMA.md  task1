# ğŸ“Š Database Schema Documentation

## Database Information

- **Database Type**: MongoDB (NoSQL)
- **Database Name**: `secure_fms`
- **Connection String**: `mongodb://localhost:27017/secure_fms`
- **ORM/ODM**: Mongoose 9.1.1

---

## Collections

### 1. Users Collection

**Collection Name**: `users`

#### Schema Definition

```javascript
const mongoose = require('mongoose');
const bcrypt = require('bcrypt');

const userSchema = mongoose.Schema({
    firstName: {
        type: String,
        required: [true, 'First name is required'],
        trim: true
    },
    lastName: {
        type: String,
        required: [true, 'Last name is required'],
        trim: true
    },
    email: {
        type: String,
        required: [true, 'Email is required'],
        unique: true,
        lowercase: true,
        trim: true,
        match: [/^\S+@\S+\.\S+$/, 'Please provide a valid email']
    },
    password: {
        type: String,
        required: [true, 'Password is required'],
        minlength: [8, 'Password must be at least 8 characters']
    },
    role: {
        type: String,
        enum: ['user', 'admin'], 
        default: 'user'
    },
    loginAttempts: {
        type: Number,
        default: 0
    },
    lastLoginAttempt: {
        type: Date,
        default: null
    }
}, {
    timestamps: true  // Automatically adds createdAt and updatedAt
});

// Password hashing middleware - runs automatically before saving
userSchema.pre('save', async function () {
    if (!this.isModified('password')) {
        return;
    }
    const salt = await bcrypt.genSalt(10);
    this.password = await bcrypt.hash(this.password, salt);
});

// Helper method to compare passwords (for login)
userSchema.methods.matchPassword = async function (enteredPassword) {
    return await bcrypt.compare(enteredPassword, this.password);
};

const User = mongoose.model('User', userSchema);
module.exports = User;
```

#### Field Specifications

| Field Name | Data Type | Required | Unique | Default Value | Validation Rules | Description |
|------------|-----------|----------|--------|---------------|------------------|-------------|
| `_id` | ObjectId | Auto | Yes | Auto-generated | MongoDB ObjectId | Primary key |
| `firstName` | String | Yes | No | - | Non-empty, trimmed | User's first name |
| `lastName` | String | Yes | No | - | Non-empty, trimmed | User's last name |
| `email` | String | Yes | Yes | - | Valid email format, lowercase | User's email address |
| `password` | String | Yes | No | - | Min 8 characters, auto-hashed | Hashed password (bcrypt) |
| `role` | String | No | No | "user" | Enum: ["user", "admin"] | User role for authorization |
| `loginAttempts` | Number | No | No | 0 | Integer â‰¥ 0 | Failed login attempt counter |
| `lastLoginAttempt` | Date | No | No | null | Valid date | Timestamp of last failed login |
| `createdAt` | Date | Auto | No | Auto-generated | ISO 8601 timestamp | Record creation time |
| `updatedAt` | Date | Auto | No | Auto-generated | ISO 8601 timestamp | Last update time |

#### Indexes

- **Primary Index**: `_id` (default MongoDB index)
- **Unique Index**: `email` (prevents duplicate email addresses)

#### Security Features

1. **Password Hashing**
   - Algorithm: bcrypt
   - Salt Rounds: 10
   - Automatic hashing via Mongoose pre-save middleware
   - Original password never stored in database

2. **Login Attempt Limiting**
   - Tracks failed login attempts
   - Locks account after 5 failed attempts
   - Lockout duration: 15 minutes
   - Auto-reset on successful login

3. **Email Validation**
   - Format validation using regex
   - Automatic lowercase conversion
   - Unique constraint prevents duplicates

#### Example Document

```json
{
  "_id": "507f1f77bcf86cd799439011",
  "firstName": "Ahmed",
  "lastName": "Mohamed",
  "email": "ahmed@example.com",
  "password": "$2b$10$N9qo8uLOickgx2ZMRZoMyeIjZAgcfl7p92ldGxad68LJZdL17lhWy",
  "role": "user",
  "loginAttempts": 0,
  "lastLoginAttempt": null,
  "createdAt": "2026-01-01T10:30:00.000Z",
  "updatedAt": "2026-01-01T10:30:00.000Z"
}
```

#### Sample Data for Testing

```javascript
// User 1 - Regular User
{
  "firstName": "Ahmed",
  "lastName": "Mohamed",
  "email": "ahmed@example.com",
  "password": "12345678",  // Will be hashed automatically
  "role": "user"
}

// User 2 - Admin User
{
  "firstName": "Admin",
  "lastName": "User",
  "email": "admin@example.com",
  "password": "adminpass123",  // Will be hashed automatically
  "role": "admin"
}

// User 3 - Test User
{
  "firstName": "Test",
  "lastName": "User",
  "email": "test@example.com",
  "password": "testpass123",  // Will be hashed automatically
  "role": "user"
}
```

---

## Database Connection

### Connection Configuration

File: `config/db.js`

```javascript
const mongoose = require('mongoose');

const connectDB = async () => {
    try {
        const conn = await mongoose.connect(process.env.MONGO_URI);
        console.log(`MongoDB Connected: ${conn.connection.host}`);
    } catch (error) {
        console.error(`Error: ${error.message}`);
        process.exit(1);
    }
};

module.exports = connectDB;
```

### Environment Variables

Required in `.env` file:

```env
MONGO_URI=mongodb://localhost:27017/secure_fms
```

### Connection String Format

**Local Development:**
```
mongodb://localhost:27017/secure_fms
```

**With Authentication:**
```
mongodb://username:password@localhost:27017/secure_fms
```

**MongoDB Atlas (Cloud):**
```
mongodb+srv://username:password@cluster.mongodb.net/secure_fms?retryWrites=true&w=majority
```

---

## Database Operations

### Create (Insert)

```javascript
const User = require('./models/User');

// Create new user
const newUser = await User.create({
    firstName: 'Ahmed',
    lastName: 'Mohamed',
    email: 'ahmed@example.com',
    password: '12345678'  // Will be hashed automatically
});
```

### Read (Query)

```javascript
// Find by email
const user = await User.findOne({ email: 'ahmed@example.com' });

// Find by ID
const user = await User.findById('507f1f77bcf86cd799439011');

// Find all users
const users = await User.find();

// Find with conditions
const adminUsers = await User.find({ role: 'admin' });
```

### Update

```javascript
// Update login attempts
user.loginAttempts += 1;
user.lastLoginAttempt = new Date();
await user.save();

// Update using findByIdAndUpdate
await User.findByIdAndUpdate(userId, {
    loginAttempts: 0,
    lastLoginAttempt: null
});
```

### Delete

```javascript
// Delete by ID
await User.findByIdAndDelete(userId);

// Delete by email
await User.deleteOne({ email: 'test@example.com' });
```

---

## MongoDB Commands

### Useful Commands

```bash
# Connect to MongoDB shell
mongo

# Or with mongosh (newer version)
mongosh

# Use database
use secure_fms

# Show all collections
show collections

# Count users
db.users.countDocuments()

# Find all users
db.users.find().pretty()

# Find specific user
db.users.findOne({ email: "ahmed@example.com" })

# Drop collection (careful!)
db.users.drop()

# Create index
db.users.createIndex({ email: 1 }, { unique: true })

# Show indexes
db.users.getIndexes()
```

---

## Backup and Restore

### Backup Database

```bash
# Backup entire database
mongodump --db secure_fms --out ./backup

# Backup specific collection
mongodump --db secure_fms --collection users --out ./backup
```

### Restore Database

```bash
# Restore entire database
mongorestore --db secure_fms ./backup/secure_fms

# Restore specific collection
mongorestore --db secure_fms --collection users ./backup/secure_fms/users.bson
```

---

## Performance Optimization

### Indexes

Current indexes on `users` collection:
- `_id` (default)
- `email` (unique)

### Query Optimization Tips

1. Always use indexes for frequently queried fields
2. Use `.lean()` for read-only queries (faster)
3. Use `.select()` to limit returned fields
4. Use pagination for large result sets

```javascript
// Optimized query example
const users = await User
    .find({ role: 'user' })
    .select('firstName lastName email')
    .limit(10)
    .lean();
```

---

## Migration Notes

### From MySQL to MongoDB

**MySQL Structure:**
```sql
CREATE TABLE users (
    id INT AUTO_INCREMENT PRIMARY KEY,
    first_name VARCHAR(50) NOT NULL,
    last_name VARCHAR(50) NOT NULL,
    email VARCHAR(100) UNIQUE NOT NULL,
    password_hash VARCHAR(255) NOT NULL,
    role ENUM('user', 'admin') DEFAULT 'user',
    login_attempts INT DEFAULT 0,
    last_login_attempt TIMESTAMP NULL,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP
);
```

**MongoDB Equivalent:**
- Uses Mongoose schema (shown above)
- `id` â†’ `_id` (ObjectId)
- `first_name` â†’ `firstName` (camelCase)
- `password_hash` â†’ `password` (still hashed)
- Timestamps handled automatically by Mongoose

---

## Security Best Practices

1. âœ… Never store plain text passwords
2. âœ… Use bcrypt for password hashing (salt rounds: 10)
3. âœ… Validate email format before saving
4. âœ… Implement rate limiting for login attempts
5. âœ… Use environment variables for connection strings
6. âœ… Enable MongoDB authentication in production
7. âœ… Regular backups
8. âœ… Use SSL/TLS for connections in production

---

## Troubleshooting

### Common Issues

**1. Connection Refused**
```
Error: connect ECONNREFUSED 127.0.0.1:27017
```
**Solution**: Ensure MongoDB service is running
```bash
# Windows
net start MongoDB

# Linux/Mac
sudo systemctl start mongod
```

**2. Duplicate Key Error**
```
E11000 duplicate key error collection: secure_fms.users index: email_1
```
**Solution**: Email already exists. Use different email or handle error gracefully.

**3. Validation Error**
```
ValidationError: User validation failed: password: Password must be at least 8 characters
```
**Solution**: Ensure password meets minimum length requirement.

---

## For Person 2 & Person 3

When creating additional collections for file management:

### Suggested File Collection Schema

```javascript
const fileSchema = mongoose.Schema({
    filename: {
        type: String,
        required: true
    },
    originalName: {
        type: String,
        required: true
    },
    encryptedPath: {
        type: String,
        required: true
    },
    size: {
        type: Number,
        required: true
    },
    mimeType: {
        type: String,
        required: true
    },
    uploadedBy: {
        type: mongoose.Schema.Types.ObjectId,
        ref: 'User',
        required: true
    }
}, {
    timestamps: true
});
```

### Suggested Access Log Schema

```javascript
const accessLogSchema = mongoose.Schema({
    fileId: {
        type: mongoose.Schema.Types.ObjectId,
        ref: 'File',
        required: true
    },
    userId: {
        type: mongoose.Schema.Types.ObjectId,
        ref: 'User',
        required: true
    },
    action: {
        type: String,
        enum: ['upload', 'download', 'delete'],
        required: true
    },
    ipAddress: String,
    timestamp: {
        type: Date,
        default: Date.now
    }
});
```

---

## Testing

### Database Test Script

File: `test-db.js` (if needed)

```javascript
const mongoose = require('mongoose');
const User = require('./models/User');
require('dotenv').config();

const testDB = async () => {
    try {
        await mongoose.connect(process.env.MONGO_URI);
        console.log('âœ… MongoDB Connected');
        
        // Count users
        const count = await User.countDocuments();
        console.log(`ğŸ“Š Total users: ${count}`);
        
        // List all users
        const users = await User.find().select('firstName lastName email role');
        console.log('ğŸ‘¥ Users:', users);
        
        mongoose.connection.close();
    } catch (error) {
        console.error('âŒ Error:', error.message);
    }
};

testDB();
```

---

## Database Status

âœ… **Current Status**: Operational  
âœ… **Connection**: Stable  
âœ… **Schema**: Validated  
âœ… **Tests**: Passing (8/8)  
âœ… **Security**: Implemented  

---

**Last Updated**: January 1, 2026  
**Version**: 1.0.0  
**Maintained By**: Person 1 (Authentication Team)
